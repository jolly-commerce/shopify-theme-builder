#!/bin/sh

# pre-push hook to analyze commits and run theme check if needed
echo "🔍 Analyzing commits for push..."

# Initialize temp files for tracking
echo "true" > /tmp/all_commits_have_skip
echo "0" > /tmp/commits_count

# Read push information line by line without subshells
while IFS= read -r line; do
    # Parse the line
    local_ref=$(echo "$line" | awk '{print $1}')
    local_sha=$(echo "$line" | awk '{print $2}')
    remote_ref=$(echo "$line" | awk '{print $3}')
    remote_sha=$(echo "$line" | awk '{print $4}')
    
    # Skip if deleting a branch
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi
    
    # Get the range of commits being pushed
    if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
        # New branch - check all commits
        range="$local_sha"
    else
        # Existing branch - check commits since last push
        range="$remote_sha..$local_sha"
    fi
    
    # Check each commit in the range
    for commit in $(git rev-list "$range"); do
        # Get commit message
        commit_msg=$(git log --format="%s%n%b" -n 1 "$commit")
        commit_subject=$(git log --format="%s" -n 1 "$commit")
        commit_hash_short=$(git log --format="%h" -n 1 "$commit")
        
        echo "  📝 $commit_hash_short: $commit_subject"
        
        # Check if this commit has --skip-theme-check flag
        if ! echo "$commit_msg" | grep -q "\-\-skip-theme-check"; then
            echo "    ❌ No --skip-theme-check flag found"
            echo "false" > /tmp/all_commits_have_skip
        else
            echo "    ✅ --skip-theme-check flag found"
        fi
        
        # Increment counter
        count=$(cat /tmp/commits_count)
        echo $((count + 1)) > /tmp/commits_count
    done
done

# Read final results
all_commits_have_skip=$(cat /tmp/all_commits_have_skip)
commits_analyzed=$(cat /tmp/commits_count)

# Cleanup temp files
rm -f /tmp/all_commits_have_skip /tmp/commits_count

echo ""
echo "📊 Analysis complete: $commits_analyzed commits analyzed"

# Check if all commits have skip flag
if [ "$all_commits_have_skip" = "true" ] && [ "$commits_analyzed" -gt 0 ]; then
    echo "🚫 All commits contain --skip-theme-check flag"
    echo "✅ Skipping theme check..."
    exit 0
elif [ "$commits_analyzed" -eq 0 ]; then
    echo "ℹ️  No commits to push"
    exit 0
else
    echo "⚠️  Not all commits have --skip-theme-check flag"
    echo "🔍 Running theme check..."
    
    if ! shopify theme check; then
        echo ""
        echo "❌ Theme check failed. Push aborted."
        echo "To bypass: git push --no-verify"
        exit 1
    fi
    
    echo "✅ Theme check passed. Proceeding with push..."
    exit 0
fi 