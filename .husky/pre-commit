#!/bin/sh

echo "✅ Be careful with your commits"

# Run npm run dev2 in background and check for errors
echo "🔍 Running npm run dev2 to check for errors..."

# Start npm run dev2 in background and capture output
npm run dev-2 > template-check.txt 2>&1 &
DEV_PID=$!

# Monitor for errors with 1 minute timeout
echo "⏱️  Monitoring for errors (max 1 minute)..."
for i in {1..60}; do
    sleep 1
    if grep -i -E "(error|To run this command, log in to Shopify)" template-check.txt >/dev/null 2>&1; then
        echo "❌ Error detected after $i seconds:"
        echo "────────────────────────────────────────"
        grep -i -E "(error|To run this command, log in to Shopify)" template-check.txt
        echo "────────────────────────────────────────"
        echo "❌ Pre-commit check failed. Commit aborted."
        kill $DEV_PID 2>/dev/null
        # rm -f template-check.txt
        exit 1
    fi
done

# Kill the dev process after 1 minute
kill $DEV_PID 2>/dev/null
wait $DEV_PID 2>/dev/null

echo "✅ No errors found in 1 minute"
rm -f template-check.txt
