name: Build Shopify Theme

on:
    workflow_call:
        secrets:
            SLACK_BOT_TOKEN:
                required: true
            CHANNEL_ID:
                required: true

env:
  NODE_VERSION: '22'

jobs:
  check-files:
    runs-on: ubuntu-latest
    outputs:
      should-build: ${{ steps.check.outputs.should-build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if build is needed
        id: check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          else
            changed_files=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          if [ -z "$changed_files" ]; then
            echo "should-build=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          non_json_files=$(echo "$changed_files" | grep -v '\.json$' || true)
          
          # Skip build only if actor is shopify[bot] AND only JSON files changed
          if [ "${{ github.actor }}" = "shopify[bot]" ] && [ -z "$non_json_files" ]; then
            echo "Shopify bot with only JSON changes, skipping build"
            echo "should-build=false" >> $GITHUB_OUTPUT
          elif [ -z "$non_json_files" ]; then
            echo "All changed files are JSON files, skipping build"
            echo "should-build=false" >> $GITHUB_OUTPUT
          else
            echo "Non-JSON files detected, proceeding with build"
            echo "should-build=true" >> $GITHUB_OUTPUT
          fi

  build:
    runs-on: ubuntu-latest
    needs: check-files
    if: needs.check-files.outputs.should-build == 'true'
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build project
        run: npm run build

      - name: Check for asset changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain assets/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Assets have been updated by the build process"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in assets"
          fi

      - name: Get shopify bot changed files
        id: shopify-changes
        if: github.actor == 'shopify[bot]'
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed_files=$(git diff --name-status origin/${{ github.base_ref }}...HEAD)
          else
            changed_files=$(git diff --name-status HEAD~1 HEAD)
          fi
          
          # Filter out JSON files and format for display
          non_json_changes=$(echo "$changed_files" | grep -v '\.json$' || true)
          
          if [ -n "$non_json_changes" ]; then
            # Format changes with status (A=Added, M=Modified, D=Deleted, R=Renamed)
            formatted_changes=$(echo "$non_json_changes" | while IFS=$'\t' read -r status file rest; do
              case "$status" in
                A*) echo "• ➕ $file" ;;
                M*) echo "• ✏️ $file" ;;
                D*) echo "• ❌ $file" ;;
                R*) echo "• 🔄 $file → $rest" ;;
                *) echo "• 📝 $file" ;;
              esac
            done | sed ':a;N;$!ba;s/\n/\\n/g')
            
            # Output for GitHub
            echo "files=$formatted_changes" >> $GITHUB_OUTPUT
            echo "has-changes=true" >> $GITHUB_OUTPUT
          else
            echo "has-changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Display changed files
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "Files that changed:"
          git status --porcelain assets/

      - name: Commit built assets
        if: steps.verify-changed-files.outputs.changed == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add assets/
          if ! git diff --staged --quiet; then
            git commit -m "🤖 Auto-build: Update compiled assets [skip ci]

          - Built from commit ${{ github.sha }}
          - Generated by GitHub Actions
          - Files updated: $(git diff --cached --name-only | wc -l)"
            git push
          else
            echo "No changes to commit — skipping push."
          fi

      - name: Build summary
        run: |
          echo "## Build Summary 📋" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js Version:** ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Assets Changed:** ${{ steps.verify-changed-files.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Assets:" >> $GITHUB_STEP_SUMMARY
          ls -la assets/jc-bundle-* assets/*.css 2>/dev/null | head -20 >> $GITHUB_STEP_SUMMARY || echo "No bundle files found" >> $GITHUB_STEP_SUMMARY

      - name: Send Slack notification on success with changes
        if: success() && steps.verify-changed-files.outputs.changed == 'true'
        run: |
          export REPO_NAME="${{ github.event.repository.name }}"
          export REPO="${{ github.repository }}"
          export BRANCH="${{ github.head_ref || github.ref_name }}"
          export SHA="${{ github.sha }}"
          export ACTOR="${{ github.actor }}"
          export SHOPIFY_CHANGES="${{ steps.shopify-changes.outputs.files }}"
          export CHANNEL_ID="${{ secrets.CHANNEL_ID }}"
          json=$(python3 -c 'import json, os; msg = "*Build Succeeded* :tada:\n*Project Name:* {repo_name}\n*Repository:* <https://github.com/{repo}|{repo}>\n*Branch:* {branch}\n*Commit:* <https://github.com/{repo}/commit/{sha}|{sha}>\n*Actor:* {actor}\n*Assets were updated*".format(repo_name=os.environ.get("REPO_NAME", ""), repo=os.environ.get("REPO", ""), branch=os.environ.get("BRANCH", ""), sha=os.environ.get("SHA", ""), actor=os.environ.get("ACTOR", "")) + (f"\n\n*Shopify Bot Changes (non-JSON):*\n{os.environ['SHOPIFY_CHANGES']}" if os.environ.get("SHOPIFY_CHANGES", "") else ""); print(json.dumps({"channel": os.environ.get("CHANNEL_ID", ""), "text": msg, "mrkdwn": True}))')
          curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" -d "$json" "https://slack.com/api/chat.postMessage"

      - name: Send Slack notification on success without changes
        if: success() && steps.verify-changed-files.outputs.changed == 'false' && github.event_name == 'push'
        run: |
          export REPO_NAME="${{ github.event.repository.name }}"
          export REPO="${{ github.repository }}"
          export BRANCH="${{ github.head_ref || github.ref_name }}"
          export SHA="${{ github.sha }}"
          export ACTOR="${{ github.actor }}"
          export SHOPIFY_CHANGES="${{ steps.shopify-changes.outputs.files }}"
          export CHANNEL_ID="${{ secrets.CHANNEL_ID }}"
          json=$(python3 -c 'import json, os; msg = "*Build Completed* :white_check_mark:\n*Project Name:* {repo_name}\n*Repository:* <https://github.com/{repo}|{repo}>\n*Branch:* {branch}\n*Commit:* <https://github.com/{repo}/commit/{sha}|{sha}>\n*Actor:* {actor}\n*No changes in assets*".format(repo_name=os.environ.get("REPO_NAME", ""), repo=os.environ.get("REPO", ""), branch=os.environ.get("BRANCH", ""), sha=os.environ.get("SHA", ""), actor=os.environ.get("ACTOR", "")) + (f"\n\n*Shopify Bot Changes (non-JSON):*\n{os.environ['SHOPIFY_CHANGES']}" if os.environ.get("SHOPIFY_CHANGES", "") else ""); print(json.dumps({"channel": os.environ.get("CHANNEL_ID", ""), "text": msg, "mrkdwn": True}))')
          curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" -d "$json" "https://slack.com/api/chat.postMessage"

      - name: Send Slack notification on failure
        if: failure()
        run: |
          export REPO_NAME="${{ github.event.repository.name }}"
          export REPO="${{ github.repository }}"
          export BRANCH="${{ github.head_ref || github.ref_name }}"
          export SHA="${{ github.sha }}"
          export ACTOR="${{ github.actor }}"
          export RUN_ID="${{ github.run_id }}"
          export SHOPIFY_CHANGES="${{ steps.shopify-changes.outputs.files }}"
          export CHANNEL_ID="${{ secrets.CHANNEL_ID }}"
          json=$(python3 -c 'import json, os; msg = "*Build Failed* :warning:\n*Project Name:* {repo_name}\n*Repository:* <https://github.com/{repo}|{repo}>\n*Branch:* {branch}\n*Commit:* <https://github.com/{repo}/commit/{sha}|{sha}>\n*Actor:* {actor}\n*Logs:* <https://github.com/{repo}/actions/runs/{run_id}|View Logs>".format(repo_name=os.environ.get("REPO_NAME", ""), repo=os.environ.get("REPO", ""), branch=os.environ.get("BRANCH", ""), sha=os.environ.get("SHA", ""), actor=os.environ.get("ACTOR", ""), run_id=os.environ.get("RUN_ID", "")) + (f"\n\n*Shopify Bot Changes (non-JSON):*\n{os.environ['SHOPIFY_CHANGES']}" if os.environ.get("SHOPIFY_CHANGES", "") else ""); print(json.dumps({"channel": os.environ.get("CHANNEL_ID", ""), "text": msg, "mrkdwn": True}))')
          curl -X POST -H "Content-Type: application/json" -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" -d "$json" "https://slack.com/api/chat.postMessage" 